---
name: 内核设计与实现
layout: post
title:  "内核设计与实现"
info: "内核设计与实现"
date:   2019-05-05
categories: WORK
tags: [Linux, 内核, 读书]
coverimg: "https://ws1.sinaimg.cn/large/88b26e1cgy1fx7cwh57tlj22kw3vc1ky.jpg"
---


## 3. 进程管理
#### 1. 进程上下文
- 代码从可执行文件载入到进程的地址空间执行
- 一般程序在用户空间执行
- 当一个程序执行了系统调用或者触发异常，则陷入内核空间
- 如无更高优先级进程需要执行并由调度器做出相应调整，在内核态退出时，程序恢复在用户空间继续执行
#### 2. 进程创建
- fork()拷贝当前进程创建子进程
- 子进程和父进程的区别仅在于PID,PPID和某些资源和统计量
- exec()函数负责读取可执行文件并将其载入地址空间开始运行
#### 3. 写时拷贝(copy-on-write)
- 传统的fork()系统调用直接把所有的资源复制给新创建的进程，效率低下
- 写实拷贝是将拷贝推迟到需要数据写入时则拷贝，否则共享同一套映像，如fork()之后马上exec()则无需复制
#### 4. 线程实现
- 线程机制提供了在同一程序内共享内存地址空间运行的一组线程，共享打开的文件和其他资源
- Linux从内核角度来讲并无线程概念，线程被视为一个与其他进程共享某些资源的进程
#### 5. 内核线程
- 内核线程无独立的地址空间，只在内核空间运行，可以被调度，抢占
- 内核线程只能由内核进程创建
#### 6. 进程终结
- 进程的析构是自身引起的，触发exit()系统调用
- 释放所占所有资源，通知父进程删除进程描述符
- 孤儿进程由init进程接管删除对应进程描述符

## 4. 进程调度
#### 1. 多任务模式
- 抢占式，每个进程有自己运行时间片(timeslice)，如不发生抢占则运行完时间片或程序结束，可动态调整时间片
- 非抢占式， 除非程序自身主动停止，否则一直运行
#### 2.调度策略
- 调度策略要在I/O密集和CPU密集中寻找平衡
- 进程优先级，nice值，实时优先级
#### 3. 抢占和上下文切换
- 用户抢占发生在系统调用返回或者中断处理程序返回
- 内核抢占发生在中断处理程序正在执行且返回内核空间之前
## 5. 系统调用
- 系统调用为用户空间提供了一组硬件的抽象接口
- 系统调用保证了系统的稳定和安全
- 系统调用是用户空间访问内核的唯一手段
- 应用程序如需调用内核空间的程序则需出发软中断，来执行异常处理程序即系统调用处理程序

## 6. 中断和中断处理
- 中断处理程序，分为两部分，因为中断上下文具有严格的时间限制
- 中断处理程序下半部分是为了减少中断线程处理器被屏蔽的时间
- 中断处理第二部分实现
```
1.软终端
2.tasklet
3.工作队列
```
## 7. 内核同步和并发
- 加锁
- 原子操作
- 信号量
- 互斥体

## 8. 定时器和时间管理
- 内核需在硬件的帮助下才能计算和管理时间
- 内核是靠已知的时钟中断间隔计算墙上时间和系统运行时间
- 定时器解决指定之间运行指定程序

## 9. 内存管理
- 内核把物理页作为内存管理的基本单位
- 处理器的最小可寻址单位是字（甚至字节）
- 内存管理单环(MMU)通常以页为单位进行处理，从虚拟内存的角度，页是最小单位

## 10. 虚拟文件系统
- 虚拟文件系统作为内核子系统，为用户空间程序提供了文件和文件系统相关接口

## 11. 块I/O层
- 系统中能够随机访问固定大小数据片的硬件设备成为块设备，比如硬盘，闪存
- 字符设备按照字节流的方式被有序访问，比如串口和键盘输出字符设备

## 12. 页高速缓存和页回写
- 页高速缓存(cache)是linux内核实现磁盘缓存，用于减少磁盘I/O
- 内存访问速度远高于磁盘访问速度，差几个数量级
- 数据访问后有很大几率在短时间内被再次访问
- 当内核执行读操作，先会检查所需数据是否存在于高速缓存中，存在则放弃读取磁盘，缓存命中，否则读取磁盘，将数据放入高速缓存中
-linux写缓存采用回写策略，程序写操作直接更新缓存，后端存储不立即直接更新，将页高速缓存中被写入的页标记为脏，加入脏页链表，由回写进程周期性写入磁盘
- 缓存回收策略 最少使用， 双链策略

## 13. 设备与模块
- 设备类型：块设备，字符设备，网络设备
- 模块：Linux内核中用于按需加载和卸载目标码的机制
- 内核对象：内核数据结构中支持面向对象的简单操作，还支持维护对象之间的父子关系
- sysfs：表示系统中设备树的一个文件系统


