---
name: MongoDB实战
layout: post
title:  "MongoDB实战"
info: "MongoDB实战"
date:   2019-05-05
categories: WORK
tags: [MongoDB]
coverimg: "https://ws1.sinaimg.cn/large/88b26e1cgy1fx7cwh57tlj22kw3vc1ky.jpg"
---
## 1.全新的web数据库
- MongoDB的设计目标之一是保留大部分关系型数据库的功能
- ad hoc queries 系统支持主动查询模式是指不需要事前定义系统接收何种查询
- MongoDB中的索引使用B-树数据结构
- MongoDB允许多个辅助索引，可以允许用户优化不同的查询
- MongoDB每个集合中可创建64个索引，升序，降序，复合键，哈希，文本，地理空间索引
- 用户可选择写入语义来维持速度与持久性之间的平衡
- .csv文件为comma-separated values 逗号分隔数据
- .tsv使用制表符的分割的数据

 数据库类型 | 实例 | 数据类型 | 伸缩性模型 | 使用场景
:----|:----|:----|:-----|:-----
简单键值存储 | Memcached |  键值，值是二进制对象 | 变化的Memcached可以跨节点伸缩，可把所有可用的RAM变为一个存储库 | 缓存，Web网站
复查键值存储| Hbase,Cassandra,Riak,Redis,CouchDB | 变化的Cassandra使用的键值结构是列，Hbase和Redis存储二进制对象，CouchDB存储JSON文档 | 最终一致性，多节点，分布式高可用和容易灾备 | 高吞吐（活动源，消息队列），缓存，Web网站
关系型数据库 | Oracle,IBM DB2,Microsoft SQl Server, MySQl, PostgreSQl | 二维表 | 垂直伸缩，限制支持集群和手动分区 | 需要事务的系统（银行和金融）或SQL，规范化数据模型

### 通过JS shell 操作MongoDB
- MongoDB数据库中所有的集合分组在相同的文件中
- MongoDB shell 同时也是js解释执行器
- 下面代码在name集合中插入20000条数据
```
for (i =0, i<20000, i++ ) {
    db.name.save({num:1});
}
```

### 编写代码操作MongoDB
- 所有MongoDB驱动都执行三个重要功能
```
1. 生成MongoDB对象id,默认都存储在所有文档的_id字段中
2. 驱动会将任意语言表示的文档对象转换为BSON或者从BSON转换回来，BSON为MongoDB使用的二进制JSON格式
3. 使用TCP socket与数据库连接通信，使用MongoDB自定义协议，socket通信的风格，特别是写入数据等待应答是非常重要的
```
- mongo中_id是是在驱动中生成，而不是在服务器上生成，关系型数据库在服务器端自增主键，因此导致服务器生成主键可能成为瓶颈
- MongoDB中_id的组成为"Unix时间戳"+"机器ID"+"进程ID"+"计数器"，目的是在多个驱动生成ID并插入文档时ID为唯一

### 面向文档的数据
- 字符串类型必须使用utf-8编码
- 数字支持三种数据类型，double,int,long,这意味着BSON可以编码任意IEEE浮点值以及任意8B长度的有符号整数
- 时间，从Unix纪元计时时开始时间值使用64b整数的毫秒值表示，负数表示之前的时间
- 文档的限制BSON文档大小限制为16MB原因有二
```
1. 阻止开发者创建无意义的数据模型，MongoDB更适合管理小文件
2. 16MB的限制与性能相关，查询大文档在发送给客户端之前要把文档拷贝到缓存中，代价昂贵，网络传输代价和反序列化代价
```
- MongoDB文档的嵌套深度最大限制为100，深层嵌套数据结构通常都通过递归函数访问，可能会导致堆栈溢出
- 大量插入的最大限制为16MB

### 5. 构建查询
- $slice 返回文档的子集
- 排序sort,创建索引是提升排序效率的关键
- 跳过和限制，skip后的数字不应太大，很大的数字会造成大量的扫描

### 6. 聚合
- 略

### 7. 更新，原子操作和删除
- 替换整个文档和操作符修改，替换操作简单，操作符方式性能好
- 乐观锁是一种确保干净更新数据但是不需要锁定数据的技术，wiki实现，可能同时有多个用户同时更新wiki页面，但是又绝不希望有用户更新已经过时的页面信息
- 悲观锁为记录会在事物里第一次访问时被锁定，直到事物结束，在此期间无法进行其他事务访问
- 原子文档处理
```
原子更新就是一个不会被其他更新中断或者与其他操作互动的操作，在此期间此条数据是不可见状态，每个MongoDB更新都是原子操作
findAndModify会返回文档更新前的数据
```
### 8. 索引理论
- 索引规则
```
1. 索引可以大大减少要处理的文档数量
2. 唯一的单键索引将会用来处理查询
3. 如果有一个复合索引a-b，那么a上的索引就是多余的，b上的不多于
4. 复合索引的键值顺序很重要
```
- 单键索引，每个索引入口对应文档索引里的单个值
- 虽然索引对于查询性能非常重要，但每个新的索引都需要额外的维护成本
- 使用MMAPv1存储引擎时，使用系统调用mmap()方法，MongoDB高速操作系统把所有的数据文件映射到内存中
- 使用WiredTiger引擎使用不同的方式，包含所有文档，集合和索引的数据文件，被操作系统加载和移除RAM，按照4K的大小移动，无论是否需要页上的数据，操作系统都必须确保RAM中的数据页可用
- 至少要确保所有加载到RAM中，所有要适当创建的索引
- MongoDB绝大部分索引使用B—数据结构
- B—树有两大特点使它非常适合作为数据库索引
```
1. 方便了各种查询，包括精确匹配，范围条件查询，排序，前缀匹配，索引查询
2. 它在添加和删除键值之后都会保持平衡
```
- 唯一索引
```
db.user.createIndex({username:1},{unique:true})
```
- 稀疏索引
```
db.user.createIndex({username:1},{unique:true,sparse:true})
```
- 哈希索引
```
db.user.createIndex({username:'hashd'})
哈希索引限制
1. 等值查询相似，不支持范围查询
2. 不支持多键哈希
3. 浮点数在哈希之前转换为整数
```
- 当有键值数据不均匀分布时，哈希函数可以创建均匀性

### 9. 文本搜索
- 略

### 10. WiredTiger与可拔插存储
- 略

### 11. 复制
- 略

### 12. 使用分片集群拓展系统
- 略

### 13. 部署和管理
- 略



