---
name: 网络协议
layout: post
title:  "网络协议"
info: "网络协议"
date:   2019-05-05
categories: WORK
tags: [网络协议, TCP/IP]
coverimg: "https://ws1.sinaimg.cn/large/88b26e1cgy1fx7cwh57tlj22kw3vc1ky.jpg"
---


### 物理层
    物理层是由光纤，电缆或者电磁波等真实处在的物理媒介
    这些媒介可以传递物理信号，比如亮度，电压或者振幅
    数字应用使用两种物理信号分别表示1和0，高电压表示1，低电压表示0
    操作系统有响应的接口来接受物理信号并解读成0/1序列
    
### 连接层
    在连接层信息已帧(frame)为单位传输，帧是一段有限的0/1序列
    连接层协议的功能就是识别0/1序列中所包含的帧，识别帧的起始
    连接层协议不关心数据中包含什么，帧就像一个信封吧数据包裹起来
    以太网和WIFI是现在最常见的连接层协议
    一个帧中只能记录SRC和DST两个地址
    
    头部
        前7个byte为序言，为了让接收设备调整接收频率，以便与发送设备的频率一致，这个过程就叫做时钟复原
        SFD为起始信号
        紧随SFD之后的是6 byte的目的地(DST, destination)和6byte的发出地(SRC, source)
        MAC地址是物理设备自带的序号，只能在同一个以太网中被识别
        头部的最后一个区域是Type，用以说明数据部分的类型。(比如0x0800为IPv4，0x0806为ARP)
    数据
        数据一般包含有符合更高层协议的数据，比如IP包
        连接层协议本身并不在乎数据是什么，它只负责传输
        数据尾部可能填充有一串0(PAD区域)。原因是数据需要超过一定的最小长度
    尾部
        跟随在数据之后的是校验序列
        通过使用高压/低压，高频率/低频率等物理信号来表示0/1可能会出现误差
        使用CRC算法来验证最后一位
    
    交换机
        交换机记录各个设备的MAC地址，当帧发送到交换机时，交换机会检查DST,然后只发送到对应端口
        
    WIFI
        WIFI的工作方式与集线器连接下的以太网很相似，一个WIFI设备会向所有WIFI设备发送帧，其他WIFI设备检查是否符合DST，故不安全
        
    
### 网络层
    1.可以从物理层上在两个网络的接收和发送0/1序列
    2.可以同时理解两种网络的帧格式
    路由器的多个网卡可接入多个网络，并理解相应的连接层协议，在帧经过路由到达另一个网络的时候，路由器会读取帧的信息，并改写以发送到另一个网络
    WIFI PC1 -> 路由器WIFI接口 -> 路由以太网接口 -> 以太网 PC2
    
    各个局域网根据IP协议互相连接，构成覆盖全球的Internet
    更高层的协议，无论是TCP还是UDP，必须通过网络层的IP数据包(datagram)来传递信息。操作系统也会提供该层的socket，从而允许用户直接操作IP包
    IPv4共有32位，第一部分来区分局域网，第二部分用来区分局域网内的主机，分类A，B，C类网络
    IPv4地址耗尽，出现128位IPv6协议，由于格式不兼容，目前的很多互联网资产和老路由器只支持IPv4，故迁移进度很慢
    
    IP地址识别的是网卡，网卡在接受网络信息之后将信息交给计算机(处理器/内存)，发送信息也通过网卡
    
    路由器实际上是一台配置有多个网卡的专用电脑
    
    IP包的传输要通过路由器的接力。每一个主机和路由中都存有一个路由表
    路由表根据目的地的IP地址，规定了等待发送的IP包所应该走的路线
    发送整个过程中，IP包不断被主机和路由封装入帧(信封)并拆开，然后借助连接层，在局域网的各个NIC之间传送帧
    每一台主机或路由中都有一个ARPcache，用以存储局域网内IP地址和MAC地址如何对应。
    RIP协议通过距离来决定生成路由表
    RIP出于技术上的原因(looping hops)，认为距离超过15的IP不可到达，电信，联通，移动
    各个边界路由器之间通过BGP来生成自己前往其它AS的路由表，而自治系统内部则参照边界路由器，使用RIP来决定路由表
    
    ICMP
    
        ICMP协议是介于网络层和传输层的协议。它的主要功能是传输网络诊断信息
        ICMP传输的信息可以分为两类，一类是错误(error)信息，这一类信息可用来诊断网络故障，当发生提供特定类型的错误，可将错误信息汇报给上游，实现尽量可靠
        另一类信息是咨询性质的，比如某台计算机询问路径上的每个路由器都是谁，然后各个路由器同样用ICMP包回答
        ICMP基于IP协议。也就是说，一个ICMP包需要封装在IP包中，然后在互联网传送
        ICMP是IP套装的必须部分，也就是说，任何一个支持IP协议的计算机，都要同时实现ICMP
        
        ICMP却经常被黑客借用进行网络攻击，比如利用伪造的IP包引发大量的ICMP回复，并将这些ICMP包导向受害主机，从而形成DoS攻击
        选择忽视某些类型的ICMP包来提高自身的安全性


    
### 传输层
    上面三层协议实现不同计算机之前通信，但计算机中有很多进程需要通信
    传输层协议TCP，
    UDP
        UDP与传统的IP传输相似，可认为是IP协议暴露在传输层的一个接口，来实现端口的与不同进程通讯，所有UDP是不可靠的
        UDP协议晚于TCP协议，可减轻网络连接成本，并实现端口概念
        
    端口
        端口是伴随着传输层诞生的概念，将网络层IP通信分送到各个进程
    
    Sokcet
        进入传输层我们可以调用操作系统中的API来构建socket，socket是操作系统提供的一个编程接口，用来代表某个网络通信
        应用程序通过socket来调用系统内核中处理网络协议的模块，而这些内核模块会负责具体的网络协议的实施
        内核来接收网络协议的细节，而我们只需要提供所要传输的内容就可以了，内核会帮我们控制格式，并进一步向底层封装
        
    TCP
        TCP协议是传输层协议，实现的是端口到端口(port)的通信，TCP协议虚拟了文本流的通信
        计算机的功能就是储存和处理文本流。CPU+memory+存储设备实现了文本流在同一台计算机内部的加工处理。
        通过一些IO，比如屏幕和键盘，文本流实现了人机交互
        如果网络通信可在不同计算机之间进行文本流的交互，那么我们就和整个计算机系统的数据处理方式实现了对接
        
        TCP协议确保了数据到达的顺序与文本流顺序相符
        超过MTU的数据会被分成多个IP包发送
        给文本流分段是在发送主机完成的，而碎片化是在网络中的路由器完成的，在主机分好段可减轻网络负担
        TCP片段的头部(header)会存有该片段的序号，来实现顺序形成流
        TCP对端在每收到一个正确的、符合次序的片段之后，就向发送方发送一个ACK回复
        通过ACK回复和重新发送机制，TCP协议将片段传输变得可靠
        使用滑窗在一定程度上实现了对乱序数据的缓存，提高效率
        
        TCP的连接是双向的
        1. 一个TCP头部需要包含出发端口(source port)和目的地端口(destination port)。这些与IP头中的两个IP地址共同确定了连接。
        2. 每个TCP片段都有序号(sequence number)。这些序号最终将数据部分的文本片段整理成为文本流。
        3. ACK是一位(bit)。只有ACK位设定的时候，回复号(Acknowledgement number)才有效。ACK回复号说明了接收方期待接收的下一个片段，所以ACK回复号为最后接收到的片段序号加1
        4. ACK后面还有SYN和FIN，它们也各占据一位(bit)
        
        连接的建立
            连接建立的最重要的目的是交换双方初始序号，TCP协议规定第一个片段的序号不能是定值
            ISN交换是通过SYN片段实现的。SYN片段由头部的SYN位表明，它的序号为发送方的ISN
            TCP传输的规则，接收到ISN的一方需要回复ACK，所以共计四片信息在建立连接过程中传输。之所以是三次握手，是因为server将发送SYN和回复ACK合并到一个TCP片段中
          
          连接的正常终结
            连接终结的过程中，连接双方也交换了四片信息两个FIN和两个ACK
            在终结连接的过程中，TCP并没有合并FIN与ACK片段。原因是TCP连接允许单向关闭，TCP连接关闭了一个方向的传输，成为一个单向连接(half-duplex)
            
        TCP是连接导向的协议，与之对应的是像UDP这样的非连接导向的协议。连接能带来更好的传输控制，但也需要更多额外的工作，比如连接的建立和终结
        
        通过滑窗与ACK的配合，我们一方面实现了TCP传输的可靠性，另一方面也一定程度上提高了效率
        通过将ACK回复“附着”在其他数据片段的方式，和累计ACK回复，减少了ACK回复所消耗的流量
        通过流量管理，TCP连接两端的工作能力可以匹配，从而减少不不要的传输浪费
        TCP协议会根据情况自动改变滑窗大小，以实现流量控制
        滑动窗口大小有可能变为0，这意味着接收方的接收能力降为0，发送方停止发送
        发送方会在零窗口后，不断探测接收方的窗口，如果依然为0，发送方会等待更长的时间，然后再次进行窗口探测，直到TCP传输恢复
        TCP协议规定发送方和接收方窗口必须达到一定尺寸方可发送
        
        包裹在IP包内的的TCP片段可能发生丢包，经过太多路由达到hop limit,路由太过拥挤，路由表没有及时更新等原因
        接受方发现TCP片段出错会丢弃TCP片段
        
        两种重新发送TCP片段的机制：超时重新发送快速重新发送
        堵塞控制
            发送速率总是在增长。如果片段丢失，则重置速率为1，并快速增长
            增长到一定程度，则进入到慢性增长。快速增长和慢性增长的切换点会随着网络状况(何时出现片段丢失)更新
            通过上面的机制，让发送速率处于动态平衡，不断的尝试更大值。初始时增长块，而接近饱和时增长慢。但一旦尝试过度，则迅速重置，以免造成网络负担
    
### 应用层
    通过以上协议可以实现任意两个进程之间通信
    应用层协议有FTP，HTTP，IMAP
    DNS
        DNS负责将域名转换为对应IP地址
        DNS协议主要基于UDP，是应用层协议
        整个DNS查询过程中，无论是重新定向还是最终取得对应关系，都是用户计算机和DNS服务器使用DNS协议通信
        用户计算机根据DNS服务器的反馈，依次与下一层的DNS服务器建立通信。用户计算机经过递归查询，最终和末端节点通信，并获得IP地址
        并不是每次域名解析都要完整的经历解析过程。DNS Resolver通常有DNS缓存(cache)，用来记录最近使用和查询的域名/IP关系
        
    HTTP
        TCP协议实现了数据流的传输。然而，人们更加习惯以文件为单位传输资源，比如文本文件，图像文件，超文本文档
        HTTP协议解决文件传输的问题。HTTP是应用层协议，主要建立在TCP协议之上(偶尔也可以UDP为底层)。它随着万维网的发展而流行。HTTP协议目的是，如何在万维网的网络环境下，更好的利用TCP协议，以实现文件，特别是超文本文件的传输。

        格式
            GET /index.html HTTP/1.1
            Host: www.example.com

            起始行只有一行。它包含了请求/回复最重要的信息。请求的起始行表示客户端请求资源。回复的起始行表示服务器回复
            
            头信息可以有多行。每一行是一对键值对，头信息是对起始行的补充。请求的头信息对服务器有指导意义，回复的头信息则是提示客户端
            
            主体部分包含了具体的资源
            
        请求
            在起始行有三段信息
                1.请求方法
                2.请求资源路径
                3.HTTP版本号1.0/1.1
            
            头信息中有字段Host表示服务器域名，默认端口为80
            
        响应
            HTTP/1.1 200 OK
            Content-type: text/plain
            Content-length: 12
            
            Hello World!
            
            起始行信息
                1.HTTP协议版本
                2.状态码
                3.状态描述
                
            Content-type说明了主体所包含的资源的类型
                text/plain 普通文本
                text/html HTML文本
                image/jpeg jpeg图片
                image/gif gif图片

            Content-length说明了主体部分的长度，以字节(byte)为单位。
            
            回应的主体部分为一段普通文本，即Hello World!
            
        无状态
            HTTP通信是无状态的。服务器认为每次请求都是一个全新的请求
            
            随着HTTP协议的发展，HTTP协议允许TCP连接复用，以节省建立连接所耗费的时间。但HTTP协议依然保持无状态的特性。

    DHCP
        DHCP协议全称为“动态主机设置协议”
        动态获取IP过程
            1.普通电脑中都内置有DHCP客户端模块。
            2.电脑接上网络后，DHCP客户端发现新连通的网络，会在该网络上找DHCP服务器。
            3.DHCP服务器将给电脑提供合理的网络配置，并把设置信息传回本机
            4.所谓的DHCP服务器，其实就是一些运行有DHCP服务器端软件的特殊电脑
            5.本机和DHCP服务器之间的通信，都是通过DHCP协议进行的
        地址分配
            地址分配原则：1.地址合法，即对应该局域网的IP地址和子网掩码，2.地址空闲，同一网络下没有其他设备使用该地址。
            DHCP服务器上存有一个地址池，里面是可用的IP地址
            当有客户端请求DHCP服务器会从地址池返回一个IP给客户端，IP有TTL
            如果主机在TTL到期之前没有续约DHCP服务器，DHCP服务器会回收IP地址
            有了动态分配，DHCP服务器不但简化了网络配置过程，还可以有效利用IP地址资源
            DHCP服务器会预留一些地址给特定MAC地址的设备使用
            
        通信过程
            DHCP协议底层是UDP协议，DHCP通信主要靠广播的形式进行
            
            1.Discovery：客户机发广播，搜寻DHCP服务器。
            2.Offer：DHCP服务器发出邀请，提供一个可用的IP地址。
            3.Request：客户机正式请求使用该IP地址。
            4.Acknowledge：DHCP服务器确认，并提供其他配置参数。
            
            每一步的通信内容都放在一个符合DHCP格式的数据包中。
            数据包中可以包括客户机IP地址、服务器IP地址、客户的硬件MAC编号等字段，还能附加多条网络设置参数。
            当某些信息未知时，如客户机的IP地址，相应的字段可以填成0。
            为了防止DHCP服务器不靠谱，客户机通常还会探测一下网络，以免该IP已经被其他设备占用。
            除了租期，DHCP服务器最终确认中，还可能加上其他网络配置信息，如DNS服务器地址、网络出口地址等。
            客户机可以选择接受，也可以拒绝DHCP服务器的“好意”，自行设置这些参数。
        DHCP攻击
            1.DHCP的一种攻击办法是从服务器那里骗IP地址，导致DHCP服务器地址耗尽，无法分配给正常用户
            2.攻击者占有了大量IP地址，可以装扮成新的DHCP服务器，把自己骗来的IP地址分配给网络上的新用户。
            3.DHCP服务器还能提供其他网络设置参数。攻击者可以让自己成为DNS服务器或者网络出口
            
    SSL/TLS
        TLS名为传输层安全协议(Transport Layer Security Protocol)，这个协议是一套加密的通信协议。
        TLS的前身是SSL协议(安全套接层协议，Secure Sockets Layer), 这两个协议的工作方式类似，但TLS协议针对SSL协议进行了一些改善。
        SSL/TLS协议利用加密的方式，在开放的互联网环境中实现了加密通信，让通信的双方可以安心的说悄悄话
        
        加密和解密用的是同一个密钥，这种加密称为对称加密
        钥匙和锁分离的加密算法就叫做非对称加密
        RSA加密算法牛逼
        SSL协议，没看懂
        
    利用CIDR，我们可以将IP地址根据需要进行分割，从而不浪费IP地址
    
    NAT(Network Address Translation)